#!/bin/bash

set -E

Dir="$(readlink -m "$(dirname "${BASH_SOURCE[0]}")/..")"
PowscriptSourceDirectory="$Dir/src"

if [ -f ./powscript ]; then
  mv "$Dir/powscript" "$Dir/.powscript.backup"
  trap '{ mv "$Dir/.powscript.backup" "$Dir/powscript"; exit; }' ERR
fi

printf '' >"$Dir/powscript"
read_file() {
  local line file
  while IFS='' read -r line || [ -n "$line" ]; do
    if [[ "$line" =~ .*'#<<EXPAND>>' ]]; then
      file=${line//*source/}
      file=${file//#*/}
      file=${file// /}
      read_file "$Dir/src/$file"
    elif [[ "$line" =~ .*'#<<INCLUDE>>' ]]; then
      file=${line//*source/}
      file=${file//#*/}
      file=${file// /}
      read_file "$(eval echo "$file")"
    else
      echo "$line" >>"$Dir/powscript"
    fi
  done <"$1"
}

read_file "$Dir/src/powscript.bash"
chmod +x "$Dir/powscript"

if [ -f "$Dir/.powscript.backup" ]; then
  rm "$Dir/.powscript.backup"
fi
